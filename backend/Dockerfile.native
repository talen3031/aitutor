# syntax=docker/dockerfile:1

### ===== Build stage =====
# 這個 image 已經包含 GraalVM + native-image + Maven
FROM ghcr.io/graalvm/native-image-maven:21 AS build

WORKDIR /app
COPY pom.xml .
RUN mvn -q -DskipTests dependency:go-offline
COPY src ./src

# 生成原生執行檔 (會放在 target/aitutor)
RUN mvn -q -Pnative -DskipTests native:compile

### ===== Runtime stage =====
FROM alpine:3.19
RUN adduser -D appuser
WORKDIR /app

# 讓 https 請求可用（例如連 DB / OpenAI API）
RUN apk add --no-cache ca-certificates

# 複製 binary（注意名稱可能是 aitutor 或 pom.xml 裡的 artifactId）
COPY --from=build /app/target/aitutor /app/app

EXPOSE 8080
USER appuser

ENTRYPOINT ["/app/app"]
