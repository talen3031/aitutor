# syntax=docker/dockerfile:1

### ===== Build stage =====
FROM ghcr.io/graalvm/native-image-community:21 AS build

# 安裝 Maven (base 是 Oracle Linux，用 microdnf)
USER root
RUN microdnf install -y maven && microdnf clean all

WORKDIR /app
COPY pom.xml .
RUN mvn -q -DskipTests dependency:go-offline
COPY src ./src

# 生成原生執行檔 (會放在 target/aitutor)
RUN mvn -q -Pnative -DskipTests native:compile

### ===== Runtime stage =====
FROM alpine:3.19

# 補上必要的動態函式庫，避免缺少依賴
RUN apk add --no-cache \
      libstdc++ \
      zlib \
      ca-certificates

RUN adduser -D appuser
WORKDIR /app

# 複製 binary（注意名稱可能是 aitutor 或 pom.xml 裡的 artifactId）
COPY --from=build /app/target/aitutor /app/app

EXPOSE 8080
USER appuser

ENTRYPOINT ["/app/app"]
